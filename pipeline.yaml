# Azure DevOps pipeline to validate, deploy S3 bucket template, and upload Java login page files to S3
trigger:
  branches:
    include:
      - main # Trigger pipeline on push to main branch
pr: none # Disable PR triggers

pool:
  vmImage: 'ubuntu-latest'

variables:
  awsServiceConnection: 'aws-oidc-federation' # AWS service connection name
  awsRegion: 'us-east-1' # AWS region
  templatePath: '$(System.DefaultWorkingDirectory)/s3-bucket.yaml' # Path to S3 template
  bucketName: 'mintuminuteonline-bucket-20250705' # Unique S3 bucket name
  stackName: 'MyS3Stack' # CloudFormation stack name

jobs:
  - job: ValidateDeployAndUpload
    displayName: 'Validate, Deploy S3 Bucket, and Upload Files'
    steps:
      - checkout: self
        displayName: 'Checkout GitHub Repository'
      - task: AWSShellScript@1
        displayName: 'Validate CloudFormation Template'
        inputs:
          awsCredentials: '$(awsServiceConnection)'
          regionName: '$(awsRegion)'
          scriptType: 'inline'
          inlineScript: |
            aws cloudformation validate-template --template-body file://$(templatePath)
      - task: AWSShellScript@1
        displayName: 'Deploy CloudFormation Stack'
        inputs:
          awsCredentials: '$(awsServiceConnection)'
          regionName: '$(awsRegion)'
          scriptType: 'inline'
          inlineScript: |
            echo "Deploying stack: $(stackName) with bucket name: $(bucketName)"
            aws cloudformation deploy \
              --template-file $(templatePath) \
              --stack-name $(stackName) \
              --parameter-overrides BucketName=$(bucketName)
      - task: AWSShellScript@1
        displayName: 'Upload Login Page Files to S3'
        inputs:
          awsCredentials: '$(awsServiceConnection)'
          regionName: '$(awsRegion)'
          scriptType: 'inline'
          inlineScript: |
            # Verify bucketName variable
            if [ -z "$(bucketName)" ]; then
              echo "Error: bucketName variable is empty or unset"
              exit 1
            fi
            echo "Uploading files to S3 bucket: $(bucketName)"
            aws s3 cp $(System.DefaultWorkingDirectory)/WebContent/login.jsp s3://$(bucketName)/login.jsp
            aws s3 cp $(System.DefaultWorkingDirectory)/WebContent/welcome.jsp s3://$(bucketName)/welcome.jsp
            aws s3 cp $(System.DefaultWorkingDirectory)/WebContent/WEB-INF/web.xml s3://$(bucketName)/WEB-INF/web.xml